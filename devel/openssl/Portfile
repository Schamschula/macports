# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 133158 2015-02-22 16:38:53Z cal@macports.org $

PortSystem          1.0
PortGroup           muniversal 1.0

name                openssl
epoch               1
version             1.0.2a

# At least the following ports statically link OpenSSL and need to be revbumped
# for every update of OpenSSL:
#  - ...
# Although they dynamically link OpenSSL, at least the following ports need to
# be revbumped for every update of OpenSSL:
#  - freeradius
#  - tor
# These lists aren't exhaustive. Feel free to add more entries as you find them.

categories          devel security
platforms           darwin
license             OpenSSL SSLeay
maintainers         larryv cal openmaintainer

description         OpenSSL SSL/TLS cryptography library
long_description    The OpenSSL Project is a collaborative effort to \
                    develop a robust, commercial-grade, full-featured, \
                    and Open Source toolkit implementing the Secure \
                    Sockets Layer (SSL v2/v3) and Transport Layer \
                    Security (TLS v1) protocols as well as \
                    a full-strength general purpose cryptography \
                    library.
homepage            http://www.openssl.org/

depends_lib         port:zlib

master_sites        http://www.openssl.org/source/
checksums           md5     a06c547dac9044161a477211049f60ef \
                    sha1    46ecd325b8e587fa491f6bb02ad4a9fb9f382f5f \
                    rmd160  2974a0a8cc469d85a5391a64aa0a2b2c5b00acfa \
                    sha256  15b6393c20030aab02c8e2fe0243cb1d1d18062f6c095d67bca91871dc7f324a

patchfiles          patch-bn_internal.pod.diff \
                    patch-crypto-Makefile.diff \
                    patch-Makefile.org-parallel.diff

# We've tried patching some, but we're not there yet, see #46719
use_parallel_build  no

configure.ccache    no
configure.perl      /usr/bin/perl
configure.cmd       ./Configure
configure.args      -L${prefix}/lib \
                    no-krb5 \
                    --openssldir=${prefix}/etc/openssl \
                    shared \
                    zlib
# Use SDK if necessary.
if {${configure.sdkroot} ne ""} {
    configure.args-append   '-isysroot ${configure.sdkroot}' \
                            -Wl,-syslibroot,${configure.sdkroot}
}

destroot.args       MANDIR=${prefix}/share/man MANSUFFIX=ssl
destroot.destdir    INSTALL_PREFIX=${destroot}

test.run            yes
test.dir            ${worksrcpath}/test
test.target         alltests

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     ${name}-(\[0-9.\]+\[a-z\]?)\\.tar\\.gz

# code for universal build
array set merger_configure_args {
    ppc     darwin-ppc-cc
    i386    darwin-i386-cc
    ppc64   darwin64-ppc-cc
    x86_64  darwin64-x86_64-cc
}
platform darwin 8 {
    append merger_configure_args(i386) " " no-asm
}

if {[variant_isset universal]} {
    set merger_arch_compiler "no"

    configure.universal_args-delete --disable-dependency-tracking

    pre-destroot {
        global merger_dont_diff
        if {[llength ${universal_archs_to_use}] > 2} {
            lappend merger_dont_diff ${prefix}/include/openssl/opensslconf.h
        }
    }

    # Do not set --host.
    array set merger_host {
        ppc     {}
        i386    {}
        ppc64   {}
        x86_64  {}
    }
} elseif {[info exists merger_configure_args($build_arch)]} {
    configure.args-append   $merger_configure_args($build_arch)
}

variant rfc3779 description {enable RFC 3779: X.509 Extensions for IP Addresses and AS Identifiers} {
    configure.args-append   enable-rfc3779
}
