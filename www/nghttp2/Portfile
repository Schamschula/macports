# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 138695 2015-07-16 15:30:48Z ionic@macports.org $

PortSystem          1.0
PortGroup           cxx11 1.0
PortGroup           github 1.0

github.setup        tatsuhiro-t nghttp2 1.1.2 v
set PythonVersion   2.7
categories          www
platforms           darwin
maintainers         gmail.com:mschamschula openmaintainer
license             MIT

description         nghttp2 is an implementation of HTTP/2 in C.

long_description    ${description} Included are a HTTP/2 client, server and proxy. The \
                    package also provides a load test and benchmarking tool for HTTP/2.

github.tarball_from releases
use_xz              yes

checksums           rmd160 863f176b35b6b1ec7f2d77eea40383650b030606 \
                    sha256 8bd4a1dde16bf82fbacfe26ba48f22f6758c2d38202e7a956e0d070372699237

depends_build       port:pkgconfig

depends_lib         port:jansson \
                    port:libev \
                    port:libevent \
                    port:libxml2 \
                    port:openssl \
                    port:py27-cython \
                    port:py27-setuptools \
                    port:python27 \
                    port:zlib

configure.args      --disable-silent-rules \
                    --disable-threads

configure.env       CYTHON=${prefix}/bin/cython-${PythonVersion} \
                    JANSSON_CFLAGS=-I${prefix}/include JANSSON_LIBS="-L${prefix}/lib -ljansson" \
                    LIBEVENT_OPENSSL_CFLAGS=-I${prefix}/include/event2 \
                    LIBEVENT_OPENSSL_LIBS="-L${prefix}/lib -levent -levent_openssl" \
                    OPENSSL_CFLAGS=-I${prefix}/include/openssl \
                    OPENSSL_LIBS="-L${prefix}/lib -lcrypto -lssl" \
                    PYTHON=${prefix}/bin/python${PythonVersion} \
                    PYTHON_EXTRA_LDFLAGS="-u _PyMac_Error ${frameworks_dir}/Python.framework/Versions/${PythonVersion}/Python"

#   Patch to deal with https://github.com/tatsuhiro-t/nghttp2/issues/303
#   Remove once this is fixed upstream.
patchfiles          patch-python-Makefile.in.diff

destroot.env        PYTHONPATH=${destroot}${prefix}/lib/python2.7/site-packages/

pre-destroot {
    xinstall -d ${destroot}${prefix}/lib/python${PythonVersion}/site-packages/
}
